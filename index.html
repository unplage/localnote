<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>素记日记 - IndexedDB版</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* 原有样式保持不变 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }

        :root {
            --primary-color: #5D5CDE;
            --secondary-color: #8A8AFF;
            --bg-color: #F8F9FA;
            --card-color: #FFFFFF;
            --text-primary: #333333;
            --text-secondary: #777777;
            --border-color: #E0E0E0;
            --shadow: 0 2px 12px rgba(0, 0, 0, 0.06);
            --radius: 12px;
            --radius-sm: 8px;
            --danger-color: #FF3B30;
            --success-color: #34C759;
            --warning-color: #FF9500;
            --info-color: #5AC8FA;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-primary);
            line-height: 1.5;
            overflow-x: hidden;
            padding-bottom: env(safe-area-inset-bottom);
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 0 16px;
        }

        /* 顶部导航栏 */
        .header {
            background-color: var(--card-color);
            padding: 16px 0;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border-color);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .logo i {
            font-size: 26px;
        }

        .header-actions {
            display: flex;
            gap: 16px;
        }

        .icon-btn {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .icon-btn:hover, .icon-btn:active {
            background-color: rgba(0, 0, 0, 0.05);
            color: var(--primary-color);
        }

        /* 主内容区 */
        .main-content {
            padding: 20px 0 40px;
        }

        /* 搜索框 */
        .search-container {
            margin-bottom: 24px;
            position: relative;
        }

        .search-box {
            width: 100%;
            padding: 14px 20px 14px 48px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 16px;
            background-color: var(--card-color);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23777777' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: 16px center;
            background-size: 20px;
            transition: all 0.2s ease;
        }

        .search-box:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(93, 92, 222, 0.1);
        }

        .clear-search {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 18px;
            cursor: pointer;
            display: none;
        }

        /* 分类筛选 - 可滚动 */
        .categories {
            display: flex;
            gap: 8px;
            margin-bottom: 24px;
            overflow-x: auto;
            padding-bottom: 4px;
        }

        .category-btn {
            padding: 8px 16px;
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-secondary);
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s ease;
        }

        .category-btn:hover {
            background-color: rgba(93, 92, 222, 0.05);
        }

        .category-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        /* 笔记列表 */
        .notes-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .note-item {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 20px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.2s ease;
            border-left: 4px solid var(--primary-color);
        }

        .note-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        }

        .note-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .note-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 1;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .note-content-preview {
            font-size: 15px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            line-height: 1.5;
        }

        .note-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .note-time {
            font-size: 13px;
            color: var(--text-secondary);
        }

        .note-category {
            font-size: 12px;
            padding: 4px 10px;
            background-color: rgba(93, 92, 222, 0.1);
            color: var(--primary-color);
            border-radius: 12px;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state i {
            font-size: 64px;
            margin-bottom: 20px;
            color: #DDDDDD;
        }

        .empty-state h3 {
            font-size: 20px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* 笔记编辑器 */
        .editor-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: var(--card-color);
            z-index: 1000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .editor-container.active {
            transform: translateX(0);
        }

        .editor-header {
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }

        .editor-actions {
            display: flex;
            gap: 12px;
        }

        .editor-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .note-title-input {
            width: 100%;
            font-size: 24px;
            font-weight: 600;
            border: none;
            outline: none;
            margin-bottom: 20px;
            padding: 8px 0;
            color: var(--text-primary);
            background: transparent;
        }

        .note-title-input::placeholder {
            color: #AAAAAA;
        }

        .note-content-input {
            width: 100%;
            min-height: 300px;
            font-size: 17px;
            line-height: 1.6;
            border: none;
            outline: none;
            color: var(--text-primary);
            background: transparent;
            resize: none;
        }

        .note-content-input::placeholder {
            color: #AAAAAA;
        }

        .editor-footer {
            padding: 16px 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .category-selector {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-select {
            padding: 8px 16px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            background-color: var(--card-color);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
        }

        /* 时间戳工具栏 */
        .timestamp-toolbar {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .timestamp-btn {
            padding: 8px 12px;
            background-color: rgba(93, 92, 222, 0.1);
            border: 1px solid rgba(93, 92, 222, 0.2);
            border-radius: var(--radius-sm);
            color: var(--primary-color);
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .timestamp-btn:hover {
            background-color: rgba(93, 92, 222, 0.2);
        }

        /* 导出/导入区域 */
        .export-section {
            background-color: var(--card-color);
            border-radius: var(--radius);
            padding: 20px;
            margin-top: 20px;
            box-shadow: var(--shadow);
        }

        .export-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .export-actions {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .export-btn {
            padding: 12px 16px;
            background-color: var(--primary-color);
            border: none;
            border-radius: var(--radius-sm);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .export-btn:hover {
            background-color: var(--secondary-color);
        }

        .export-btn.secondary {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .export-btn.secondary:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .export-btn.danger {
            background-color: var(--danger-color);
        }

        .export-btn.danger:hover {
            background-color: #FF5A50;
        }

        .export-btn.success {
            background-color: var(--success-color);
        }

        .export-btn.success:hover {
            background-color: #3AD46A;
        }

        /* 底部添加按钮 */
        .add-button {
            position: fixed;
            bottom: 24px;
            right: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background-color: var(--primary-color);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(93, 92, 222, 0.3);
            z-index: 10;
            transition: all 0.2s ease;
        }

        .add-button:hover, .add-button:active {
            background-color: var(--secondary-color);
            transform: scale(1.05);
        }

        /* 模态对话框 */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background-color: var(--card-color);
            border-radius: var(--radius);
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(20px);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal {
            transform: translateY(0);
        }

        .modal-header {
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            font-size: 20px;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .modal-body {
            padding: 20px;
        }

        .modal-footer {
            padding: 20px;
            border-top: 1px solid var(--border-color);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: var(--radius-sm);
            border: none;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .modal-btn.primary {
            background-color: var(--primary-color);
            color: white;
        }

        .modal-btn.primary:hover {
            background-color: var(--secondary-color);
        }

        .modal-btn.secondary {
            background-color: var(--card-color);
            border: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .modal-btn.secondary:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        /* === 新增样式：自动保存状态 === */
        .auto-save-status {
            position: fixed;
            top: 70px;
            right: 20px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            opacity: 0;
            transform: translateY(-10px);
            transition: all 0.3s ease;
            z-index: 100;
        }

        .auto-save-status.show {
            opacity: 1;
            transform: translateY(0);
        }

        .auto-save-status.saving {
            background-color: var(--info-color);
            color: white;
        }

        .auto-save-status.saved {
            background-color: var(--success-color);
            color: white;
        }

        .auto-save-status.error {
            background-color: var(--danger-color);
            color: white;
        }

        /* === 新增样式：分类管理 === */
        .category-manage-btn {
            background: none;
            border: 1px solid var(--primary-color);
            color: var(--primary-color);
            padding: 4px 8px;
            border-radius: var(--radius-sm);
            font-size: 12px;
            cursor: pointer;
            margin-left: 8px;
        }

        .category-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-bottom: 16px;
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
        }

        .category-color-picker {
            width: 24px;
            height: 24px;
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
        }

        .category-name-input {
            flex: 1;
            border: none;
            background: transparent;
            font-size: 14px;
            padding: 4px;
        }

        .category-actions {
            display: flex;
            gap: 4px;
        }

        .category-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            background: transparent;
            cursor: pointer;
            border-radius: 50%;
            color: var(--text-secondary);
        }

        .category-action-btn:hover {
            background-color: var(--bg-color);
            color: var(--primary-color);
        }

        .add-category-form {
            display: flex;
            gap: 8px;
            align-items: center;
            padding: 12px;
            border: 1px dashed var(--border-color);
            border-radius: var(--radius-sm);
        }

        .add-category-input {
            flex: 1;
            border: none;
            background: transparent;
            padding: 8px;
        }

        /* === 新增样式：设置面板 === */
        .settings-section {
            margin-top: 24px;
            padding: 20px;
            background-color: var(--card-color);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .settings-section h3 {
            font-size: 18px;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .setting-item:last-child {
            border-bottom: none;
        }

        .setting-label {
            font-size: 14px;
            color: var(--text-primary);
        }

        .setting-control {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-input {
            padding: 6px 8px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-sm);
            font-size: 14px;
            width: 80px;
        }

        /* 响应式调整 */
        @media (max-width: 480px) {
            .container {
                padding: 0 12px;
            }
            
            .header {
                padding: 12px 0;
            }
            
            .note-item {
                padding: 16px;
            }
            
            .note-title {
                font-size: 17px;
            }
            
            .note-content-preview {
                font-size: 14px;
            }
            
            .export-actions {
                flex-direction: column;
            }
            
            .timestamp-toolbar {
                flex-direction: column;
            }

            .category-btn {
                font-size: 12px;
                padding: 6px 12px;
            }
        }

        /* 动画 */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease;
        }

        /* 暗色模式支持 */
        @media (prefers-color-scheme: dark) {
            :root {
                --bg-color: #121212;
                --card-color: #1E1E1E;
                --text-primary: #E0E0E0;
                --text-secondary: #AAAAAA;
                --border-color: #333333;
                --shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
                --primary-color: #8A8AFF;
                --secondary-color: #A5A5FF;
            }
            
            .search-box {
                background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23AAAAAA' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
            }
            
            .icon-btn:hover, .icon-btn:active {
                background-color: rgba(255, 255, 255, 0.1);
            }
            
            .empty-state i {
                color: #333333;
            }
            
            .export-btn.secondary {
                background-color: #2C2C2C;
            }
            
            .timestamp-btn {
                background-color: rgba(138, 138, 255, 0.1);
                border-color: rgba(138, 138, 255, 0.2);
            }
        }
    </style>
</head>
<body>
    <!-- 自动保存状态指示 -->
    <div class="auto-save-status" id="autoSaveStatus"></div>

    <!-- 顶部导航栏 -->
    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-book"></i>
                    <span>素记日记</span>
                </div>
                <div class="header-actions">
                    <button class="icon-btn" id="searchBtn" title="搜索">
                        <i class="fas fa-search"></i>
                    </button>
                    <button class="icon-btn" id="categoryManageBtn" title="管理分类">
                        <i class="fas fa-tags"></i>
                    </button>
                    <button class="icon-btn" id="exportBtn" title="导出/导入">
                        <i class="fas fa-file-export"></i>
                    </button>
                    <button class="icon-btn" id="themeBtn" title="切换主题">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="main-content">
        <div class="container">
            <!-- 搜索框 -->
            <div class="search-container" id="searchContainer" style="display: none;">
                <input type="text" class="search-box" id="searchInput" placeholder="搜索标题、内容或分类...">
                <button class="clear-search" id="clearSearch">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <!-- 分类筛选 -->
            <div class="categories" id="categories">
                <!-- 动态生成分类按钮 -->
            </div>

            <!-- 笔记列表 -->
            <div class="notes-list" id="notesList">
                <!-- 笔记项会通过JavaScript动态生成 -->
            </div>

            <!-- 导出/导入区域 -->
            <div class="export-section" id="exportSection" style="display: none;">
                <h3><i class="fas fa-file-export"></i> 数据管理</h3>
                <div class="export-actions">
                    <button class="export-btn" id="exportJsonBtn">
                        <i class="fas fa-download"></i> 导出为JSON文件
                    </button>
                    <button class="export-btn" id="exportTxtBtn">
                        <i class="fas fa-file-alt"></i> 导出为Markdown文件
                    </button>
                    <button class="export-btn secondary" id="importBtn">
                        <i class="fas fa-upload"></i> 从文件导入笔记
                    </button>
                    <button class="export-btn success" id="backupBtn">
                        <i class="fas fa-copy"></i> 创建备份
                    </button>
                    <button class="export-btn danger" id="clearDataBtn">
                        <i class="fas fa-trash-alt"></i> 清除所有数据
                    </button>
                </div>
            </div>

            <!-- 设置区域 -->
            <div class="settings-section" id="settingsSection" style="display: none;">
                <h3><i class="fas fa-cog"></i> 设置</h3>
                <div class="setting-item">
                    <label class="setting-label">自动保存间隔（秒）</label>
                    <div class="setting-control">
                        <input type="number" class="setting-input" id="autoSaveIntervalInput" value="3" min="1" max="30">
                        <span>秒</span>
                    </div>
                </div>
                <div class="setting-item">
                    <label class="setting-label">显示自动保存状态</label>
                    <div class="setting-control">
                        <input type="checkbox" id="autoSaveShowStatus" checked>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 笔记编辑器 -->
    <div class="editor-container" id="editorContainer">
        <div class="editor-header">
            <button class="icon-btn" id="closeEditor">
                <i class="fas fa-arrow-left"></i>
            </button>
            <div class="editor-actions">
                <button class="icon-btn" id="timestampBtn" title="插入时间戳">
                    <i class="fas fa-clock"></i>
                </button>
                <button class="icon-btn" id="saveNote" title="保存">
                    <i class="fas fa-check"></i>
                </button>
                <button class="icon-btn" id="deleteNote" title="删除">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        
        <div class="editor-content">
            <input type="text" class="note-title-input" id="noteTitleInput" placeholder="标题">
            
            <!-- 时间戳工具栏 -->
            <div class="timestamp-toolbar" id="timestampToolbar">
                <button class="timestamp-btn" data-format="datetime">
                    <i class="fas fa-calendar-alt"></i> 日期时间
                </button>
                <button class="timestamp-btn" data-format="date">
                    <i class="fas fa-calendar-day"></i> 日期
                </button>
                <button class="timestamp-btn" data-format="time">
                    <i class="fas fa-clock"></i> 时间
                </button>
                <button class="timestamp-btn" data-format="week">
                    <i class="fas fa-calendar-week"></i> 星期
                </button>
                <button class="timestamp-btn" data-format="custom">
                    <i class="fas fa-pen"></i> 自定义格式
                </button>
            </div>
            
            <textarea class="note-content-input" id="noteContentInput" placeholder="开始记录..."></textarea>
        </div>
        
        <div class="editor-footer">
            <div class="category-selector">
                <span>分类:</span>
                <select class="category-select" id="categorySelect">
                    <!-- 动态生成分类选项 -->
                </select>
            </div>
            <div class="note-time" id="noteTimeDisplay"></div>
        </div>
    </div>

    <!-- 分类管理模态框 -->
    <div class="modal-overlay" id="categoryManageModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-tags"></i> 管理分类</h3>
                <button class="modal-close" id="closeCategoryManageModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div class="category-list" id="categoryList">
                    <!-- 动态生成分类列表 -->
                </div>
                <div class="add-category-form">
                    <input type="text" class="add-category-input" id="newCategoryName" placeholder="新分类名称">
                    <input type="color" class="category-color-picker" id="newCategoryColor" value="#5D5CDE">
                    <button class="export-btn primary" id="addNewCategoryBtn">添加</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 自定义时间戳格式模态框 -->
    <div class="modal-overlay" id="customTimestampModal">
        <div class="modal">
            <div class="modal-header">
                <h3>自定义时间戳格式</h3>
                <button class="modal-close" id="closeCustomTimestampModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <label for="customFormatInput" style="display: block; margin-bottom: 8px; font-weight: 500;">格式字符串:</label>
                    <input type="text" class="search-box" style="width: 100%; background-position: 12px center; padding-left: 40px;" id="customFormatInput" value="YYYY年MM月DD日 HH:mm:ss">
                    <div style="font-size: 13px; color: var(--text-secondary); margin-top: 8px;">
                        可用格式: YYYY(年), MM(月), DD(日), HH(时), mm(分), ss(秒), ddd(星期)
                    </div>
                </div>
                <div style="margin-bottom: 16px;">
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">预览:</label>
                    <div id="formatPreview" style="padding: 12px; background-color: rgba(93, 92, 222, 0.05); border-radius: var(--radius-sm); font-family: monospace;">
                        <!-- 预览内容将通过JS填充 -->
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 8px; font-weight: 500;">预设格式:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="timestamp-btn" data-preset="YYYY年MM月DD日 HH:mm:ss">标准格式</button>
                        <button class="timestamp-btn" data-preset="YYYY年MM月DD日 HH时mm分">中文格式</button>
                        <button class="timestamp-btn" data-preset="DD/MM/YYYY">日期格式</button>
                        <button class="timestamp-btn" data-preset="HH:mm:ss">时间格式</button>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancelCustomTimestamp">取消</button>
                <button class="modal-btn primary" id="insertCustomTimestamp">插入时间戳</button>
            </div>
        </div>
    </div>

    <!-- 导入确认模态框 -->
    <div class="modal-overlay" id="importModal">
        <div class="modal">
            <div class="modal-header">
                <h3>导入笔记</h3>
                <button class="modal-close" id="closeImportModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 16px;">
                    <p>请选择要导入的文件格式：</p>
                </div>
                <div style="display: flex; flex-direction: column; gap: 12px;">
                    <button class="export-btn secondary" id="importJsonBtn">
                        <i class="fas fa-file-code"></i> 导入JSON文件
                    </button>
                    <button class="export-btn secondary" id="importTxtBtn">
                        <i class="fas fa-file-alt"></i> 导入Markdown文件
                    </button>
                </div>
                <div style="margin-top: 20px; padding: 12px; background-color: rgba(255, 59, 48, 0.05); border-radius: var(--radius-sm);">
                    <p style="font-size: 14px; color: var(--danger-color); margin: 0;">
                        <i class="fas fa-exclamation-triangle"></i> 注意：导入会添加新笔记，但不会删除现有笔记。
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- 清除数据确认模态框 -->
    <div class="modal-overlay" id="clearDataModal">
        <div class="modal">
            <div class="modal-header">
                <h3><i class="fas fa-exclamation-triangle" style="color: var(--danger-color);"></i> 清除所有数据</h3>
                <button class="modal-close" id="closeClearDataModal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 20px;">
                    <p>您确定要清除所有笔记数据吗？此操作无法撤销！</p>
                    <p style="color: var(--danger-color); font-weight: 500; margin-top: 8px;">所有笔记将被永久删除。</p>
                </div>
                <div style="padding: 12px; background-color: rgba(255, 59, 48, 0.05); border-radius: var(--radius-sm);">
                    <p style="font-size: 14px; margin: 0;">
                        <i class="fas fa-lightbulb"></i> 建议：在清除数据前，请先导出备份您的笔记。
                    </p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="modal-btn secondary" id="cancelClearData">取消</button>
                <button class="modal-btn danger" id="confirmClearData" style="background-color: var(--danger-color);">清除所有数据</button>
            </div>
        </div>
    </div>

    <!-- 添加按钮 -->
    <button class="add-button" id="addButton">
        <i class="fas fa-plus"></i>
    </button>

    <script>
        // ===== 配置常量 =====
        const CONFIG = {
            AUTO_SAVE_INTERVAL: 3000, // 默认3秒
            DEFAULT_CATEGORIES: [
                { id: 'daily', name: '日常', color: '#5D5CDE', icon: 'fa-book' },
                { id: 'work', name: '工作', color: '#FF9500', icon: 'fa-briefcase' },
                { id: 'ideas', name: '想法', color: '#34C759', icon: 'fa-lightbulb' },
                { id: 'memories', name: '回忆', color: '#FF69B4', icon: 'fa-heart' },
                { id: 'other', name: '其他', color: '#9E9E9E', icon: 'fa-question' }
            ]
        };

        // ===== IndexedDB 数据库管理器 =====
        class IndexedDBManager {
            constructor() {
                this.dbName = 'SimpleNotesDB';
                this.dbVersion = 1;
                this.db = null;
            }

            // 打开数据库连接
            async openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(this.dbName, this.dbVersion);

                    request.onerror = (event) => {
                        console.error('IndexedDB打开失败:', event.target.error);
                        reject(event.target.error);
                    };

                    request.onsuccess = (event) => {
                        this.db = event.target.result;
                        console.log('IndexedDB连接成功');
                        
                        // 确保默认分类存在
                        this.ensureDefaultCategories().then(() => {
                            resolve(this.db);
                        }).catch(error => {
                            console.error('确保默认分类失败:', error);
                            resolve(this.db); // 即使失败也继续
                        });
                    };

                    request.onupgradeneeded = (event) => {
                        const db = event.target.result;
                        
                        // 创建对象存储
                        if (!db.objectStoreNames.contains('notes')) {
                            const notesStore = db.createObjectStore('notes', { keyPath: 'id' });
                            notesStore.createIndex('category', 'category', { unique: false });
                            notesStore.createIndex('updatedAt', 'updatedAt', { unique: false });
                        }

                        if (!db.objectStoreNames.contains('categories')) {
                            const categoriesStore = db.createObjectStore('categories', { keyPath: 'id' });
                            categoriesStore.createIndex('name', 'name', { unique: true });
                        }

                        if (!db.objectStoreNames.contains('settings')) {
                            db.createObjectStore('settings', { keyPath: 'key' });
                        }

                        if (!db.objectStoreNames.contains('backup')) {
                            db.createObjectStore('backup', { keyPath: 'timestamp' });
                        }
                    };
                });
            }

            // 确保默认分类存在
            async ensureDefaultCategories() {
                if (!this.db) return;
                
                try {
                    const categories = await this.getAllCategories();
                    const defaultCategoryIds = CONFIG.DEFAULT_CATEGORIES.map(cat => cat.id);
                    
                    // 找出缺失的默认分类
                    const existingIds = categories.map(cat => cat.id);
                    const missingDefaults = CONFIG.DEFAULT_CATEGORIES.filter(
                        cat => !existingIds.includes(cat.id)
                    );
                    
                    if (missingDefaults.length > 0) {
                        console.log('添加缺失的默认分类:', missingDefaults);
                        await this.saveMultipleCategories(missingDefaults);
                    }
                } catch (error) {
                    console.error('确保默认分类失败:', error);
                }
            }

            // 批量保存分类
            async saveMultipleCategories(categories) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    
                    categories.forEach(category => {
                        store.put(category);
                    });

                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            }

            // ===== 笔记操作 =====
            async getAllNotes() {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['notes'], 'readonly');
                    const store = transaction.objectStore('notes');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const notes = request.result.sort((a, b) => 
                            new Date(b.updatedAt) - new Date(a.updatedAt)
                        );
                        resolve(notes);
                    };

                    request.onerror = () => reject(request.error);
                });
            }

            async getNote(id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['notes'], 'readonly');
                    const store = transaction.objectStore('notes');
                    const request = store.get(Number(id));

                    request.onsuccess = () => resolve(request.result);
                    request.onerror = () => reject(request.error);
                });
            }

            async saveNote(note) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['notes'], 'readwrite');
                    const store = transaction.objectStore('notes');
                    
                    // 确保ID是数字
                    note.id = Number(note.id) || Date.now();
                    
                    const request = store.put(note);

                    request.onsuccess = () => resolve(note);
                    request.onerror = () => reject(request.error);
                });
            }

            async deleteNote(id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['notes'], 'readwrite');
                    const store = transaction.objectStore('notes');
                    const request = store.delete(Number(id));

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            async searchNotes(searchTerm, categoryFilter = 'all') {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['notes'], 'readonly');
                    const store = transaction.objectStore('notes');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        let notes = request.result;

                        // 按分类筛选
                        if (categoryFilter !== 'all') {
                            notes = notes.filter(note => note.category === categoryFilter);
                        }

                        // 按搜索词筛选
                        if (searchTerm.trim() !== '') {
                            const term = searchTerm.toLowerCase();
                            notes = notes.filter(note => {
                                const titleMatch = note.title.toLowerCase().includes(term);
                                const contentMatch = note.content.toLowerCase().includes(term);
                                return titleMatch || contentMatch;
                            });
                        }

                        // 按更新时间倒序排序
                        notes.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                        resolve(notes);
                    };

                    request.onerror = () => reject(request.error);
                });
            }

            // ===== 分类操作 =====
            async getAllCategories() {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        // 如果数据库未连接，返回默认分类
                        resolve(CONFIG.DEFAULT_CATEGORIES);
                        return;
                    }

                    const transaction = this.db.transaction(['categories'], 'readonly');
                    const store = transaction.objectStore('categories');
                    const request = store.getAll();

                    request.onsuccess = () => {
                        const categories = request.result;
                        
                        // 如果没有分类，返回默认分类
                        if (categories.length === 0) {
                            resolve(CONFIG.DEFAULT_CATEGORIES);
                        } else {
                            // 合并默认分类和用户自定义分类
                            const defaultCategoryIds = CONFIG.DEFAULT_CATEGORIES.map(cat => cat.id);
                            const userCategories = categories.filter(cat => !defaultCategoryIds.includes(cat.id));
                            
                            // 确保默认分类的属性正确（比如颜色、图标等）
                            const defaultCategories = CONFIG.DEFAULT_CATEGORIES.map(defaultCat => {
                                const existing = categories.find(cat => cat.id === defaultCat.id);
                                return existing ? { ...defaultCat, ...existing } : defaultCat;
                            });
                            
                            // 合并默认分类和用户自定义分类
                            const mergedCategories = [...defaultCategories, ...userCategories];
                            resolve(mergedCategories);
                        }
                    };
                    request.onerror = () => {
                        console.error('获取分类失败，返回默认分类');
                        resolve(CONFIG.DEFAULT_CATEGORIES);
                    };
                });
            }

            async saveCategory(category) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    
                    // 如果是默认分类，确保其基本属性不变
                    const defaultCategory = CONFIG.DEFAULT_CATEGORIES.find(cat => cat.id === category.id);
                    if (defaultCategory) {
                        category = {
                            ...defaultCategory,
                            ...category // 允许覆盖颜色等属性
                        };
                    }
                    
                    const request = store.put(category);

                    request.onsuccess = () => resolve(category);
                    request.onerror = (event) => {
                        // 如果是唯一性约束错误（重复名称）
                        if (event.target.error.name === 'ConstraintError') {
                            reject(new Error('分类名称已存在'));
                        } else {
                            reject(event.target.error);
                        }
                    };
                });
            }

            async deleteCategory(id) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        reject(new Error('数据库未连接'));
                        return;
                    }

                    const transaction = this.db.transaction(['categories'], 'readwrite');
                    const store = transaction.objectStore('categories');
                    const request = store.delete(id);

                    request.onsuccess = () => resolve(true);
                    request.onerror = () => reject(request.error);
                });
            }

            // ===== 设置操作 =====
            async getSetting(key, defaultValue = null) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        resolve(defaultValue);
                        return;
                    }

                    const transaction = this.db.transaction(['settings'], 'readonly');
                    const store = transaction.objectStore('settings');
                    const request = store.get(key);

                    request.onsuccess = () => {
                        resolve(request.result ? request.result.value : defaultValue);
                    };
                    request.onerror = () => {
                        console.error('获取设置失败:', request.error);
                        resolve(defaultValue);
                    };
                });
            }

            async saveSetting(key, value) {
                return new Promise((resolve, reject) => {
                    if (!this.db) {
                        resolve(value);
                        return;
                    }

                    const transaction = this.db.transaction(['settings'], 'readwrite');
                    const store = transaction.objectStore('settings');
                    const request = store.put({ key, value });

                    request.onsuccess = () => resolve(value);
                    request.onerror = () => {
                        console.error('保存设置失败:', request.error);
                        resolve(value);
                    };
                });
            }

            // ===== 清空数据 =====
            async clearAllData() {
                const stores = ['notes', 'categories', 'settings', 'backup'];
                
                for (const storeName of stores) {
                    await new Promise((resolve, reject) => {
                        if (!this.db) {
                            resolve();
                            return;
                        }

                        const transaction = this.db.transaction([storeName], 'readwrite');
                        const store = transaction.objectStore(storeName);
                        const request = store.clear();

                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                }

                return true;
            }
        }

        // ===== 应用主类 =====
        class SimpleNotesApp {
            constructor() {
                this.dbManager = new IndexedDBManager();
                this.currentFilter = 'all';
                this.currentSearch = '';
                this.editingNoteId = null;
                this.autoSaveTimer = null;
                this.lastSavedContent = '';
                this.settings = {
                    autoSaveInterval: CONFIG.AUTO_SAVE_INTERVAL,
                    showAutoSaveStatus: true
                };
                this.categoriesList = [];
                
                this.initElements();
                this.initApp();
            }

            initElements() {
                // 主界面元素
                this.notesList = document.getElementById('notesList');
                this.searchContainer = document.getElementById('searchContainer');
                this.searchInput = document.getElementById('searchInput');
                this.clearSearch = document.getElementById('clearSearch');
                this.categories = document.getElementById('categories');
                this.addButton = document.getElementById('addButton');
                this.searchBtn = document.getElementById('searchBtn');
                this.exportBtn = document.getElementById('exportBtn');
                this.themeBtn = document.getElementById('themeBtn');
                this.exportSection = document.getElementById('exportSection');
                this.categoryManageBtn = document.getElementById('categoryManageBtn');
                this.autoSaveStatus = document.getElementById('autoSaveStatus');

                // 导出/导入按钮
                this.exportJsonBtn = document.getElementById('exportJsonBtn');
                this.exportTxtBtn = document.getElementById('exportTxtBtn');
                this.importBtn = document.getElementById('importBtn');
                this.backupBtn = document.getElementById('backupBtn');
                this.clearDataBtn = document.getElementById('clearDataBtn');

                // 设置相关
                this.settingsSection = document.getElementById('settingsSection');
                this.autoSaveIntervalInput = document.getElementById('autoSaveIntervalInput');
                this.autoSaveShowStatus = document.getElementById('autoSaveShowStatus');

                // 编辑器元素
                this.editorContainer = document.getElementById('editorContainer');
                this.noteTitleInput = document.getElementById('noteTitleInput');
                this.noteContentInput = document.getElementById('noteContentInput');
                this.categorySelect = document.getElementById('categorySelect');
                this.noteTimeDisplay = document.getElementById('noteTimeDisplay');
                this.closeEditor = document.getElementById('closeEditor');
                this.saveNote = document.getElementById('saveNote');
                this.deleteNote = document.getElementById('deleteNote');
                this.timestampBtn = document.getElementById('timestampBtn');
                this.timestampToolbar = document.getElementById('timestampToolbar');

                // 模态框
                this.categoryManageModal = document.getElementById('categoryManageModal');
                this.categoryList = document.getElementById('categoryList');
                this.closeCategoryManageModal = document.getElementById('closeCategoryManageModal');
                this.newCategoryName = document.getElementById('newCategoryName');
                this.newCategoryColor = document.getElementById('newCategoryColor');
                this.addNewCategoryBtn = document.getElementById('addNewCategoryBtn');

                this.customTimestampModal = document.getElementById('customTimestampModal');
                this.customFormatInput = document.getElementById('customFormatInput');
                this.formatPreview = document.getElementById('formatPreview');
                this.closeCustomTimestampModal = document.getElementById('closeCustomTimestampModal');
                this.cancelCustomTimestamp = document.getElementById('cancelCustomTimestamp');
                this.insertCustomTimestamp = document.getElementById('insertCustomTimestamp');

                this.importModal = document.getElementById('importModal');
                this.closeImportModal = document.getElementById('closeImportModal');
                this.importJsonBtn = document.getElementById('importJsonBtn');
                this.importTxtBtn = document.getElementById('importTxtBtn');

                this.clearDataModal = document.getElementById('clearDataModal');
                this.closeClearDataModal = document.getElementById('closeClearDataModal');
                this.cancelClearData = document.getElementById('cancelClearData');
                this.confirmClearData = document.getElementById('confirmClearData');
            }

            async initApp() {
                try {
                    // 打开数据库
                    await this.dbManager.openDatabase();
                    
                    // 初始化设置
                    await this.loadSettings();
                    
                    // 绑定事件
                    this.bindEvents();
                    
                    // 加载数据
                    await this.loadCategories();
                    await this.renderCategories();
                    await this.renderNotes();
                    
                    // 加载设置到UI
                    this.loadSettingsToUI();
                    
                    console.log('素记日记IndexedDB版已加载');
                } catch (error) {
                    console.error('应用初始化失败:', error);
                    this.showMessage('应用初始化失败，请刷新页面重试', 'error');
                }
            }

            bindEvents() {
                // 添加新笔记按钮
                this.addButton.addEventListener('click', () => this.openEditor());

                // 搜索相关
                this.searchBtn.addEventListener('click', () => this.toggleSearch());
                this.searchInput.addEventListener('input', (e) => this.handleSearch(e.target.value));
                this.clearSearch.addEventListener('click', () => this.clearSearchHandler());

                // 分类管理
                this.categoryManageBtn.addEventListener('click', () => {
                    console.log('分类管理按钮被点击');
                    this.showCategoryManageModal();
                });

                // 分类筛选
                this.categories.addEventListener('click', (e) => {
                    const categoryBtn = e.target.closest('.category-btn');
                    if (categoryBtn) {
                        this.handleCategoryFilter(categoryBtn.dataset.category);
                    }
                });

                // 导出/导入相关
                this.exportBtn.addEventListener('click', () => this.toggleExportSection());
                this.exportJsonBtn.addEventListener('click', () => this.exportNotes('json'));
                this.exportTxtBtn.addEventListener('click', () => this.exportNotes('txt'));
                this.importBtn.addEventListener('click', () => this.showImportModal());
                this.backupBtn.addEventListener('click', () => this.createBackup());
                this.clearDataBtn.addEventListener('click', () => this.showClearDataModal());

                // 编辑器相关
                this.closeEditor.addEventListener('click', () => this.closeEditorHandler());
                this.saveNote.addEventListener('click', () => this.saveNoteHandler());
                this.deleteNote.addEventListener('click', () => this.deleteNoteHandler());

                // 自动保存相关
                this.noteTitleInput.addEventListener('input', () => this.triggerAutoSave());
                this.noteContentInput.addEventListener('input', () => this.triggerAutoSave());
                this.categorySelect.addEventListener('change', () => this.triggerAutoSave());

                // 时间戳功能
                this.timestampBtn.addEventListener('click', () => this.toggleTimestampToolbar());
                this.timestampToolbar.addEventListener('click', (e) => {
                    const btn = e.target.closest('.timestamp-btn');
                    if (btn) {
                        const format = btn.dataset.format;
                        this.handleTimestampInsert(format);
                    }
                });

                // 时间戳模态框
                this.closeCustomTimestampModal.addEventListener('click', () => this.hideModal(this.customTimestampModal));
                this.cancelCustomTimestamp.addEventListener('click', () => this.hideModal(this.customTimestampModal));
                this.insertCustomTimestamp.addEventListener('click', () => this.insertCustomTimestampHandler());

                // 自定义格式输入事件
                this.customFormatInput.addEventListener('input', () => this.updateFormatPreview());

                // 预设格式按钮
                document.querySelectorAll('[data-preset]').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const preset = e.target.dataset.preset;
                        this.customFormatInput.value = preset;
                        this.updateFormatPreview();
                    });
                });

                // 导入模态框
                this.closeImportModal.addEventListener('click', () => this.hideModal(this.importModal));
                this.importJsonBtn.addEventListener('click', () => this.importNotes('json'));
                this.importTxtBtn.addEventListener('click', () => this.importNotes('txt'));

                // 清除数据模态框
                this.closeClearDataModal.addEventListener('click', () => this.hideModal(this.clearDataModal));
                this.cancelClearData.addEventListener('click', () => this.hideModal(this.clearDataModal));
                this.confirmClearData.addEventListener('click', () => this.confirmClearDataHandler());

                // 分类管理模态框 - 添加关闭按钮事件
                this.closeCategoryManageModal.addEventListener('click', () => this.hideModal(this.categoryManageModal));
                
                // 分类管理模态框 - 添加新分类按钮
                this.addNewCategoryBtn.addEventListener('click', () => this.addNewCategory());

                // 设置相关
                this.autoSaveIntervalInput.addEventListener('change', (e) => {
                    const value = parseInt(e.target.value);
                    if (value >= 1 && value <= 30) {
                        this.updateSetting('autoSaveInterval', value * 1000);
                        this.showMessage(`自动保存间隔已设置为${value}秒`, 'success');
                    }
                });

                this.autoSaveShowStatus.addEventListener('change', (e) => {
                    this.updateSetting('showAutoSaveStatus', e.target.checked);
                    this.showMessage('设置已保存', 'success');
                });

                // 主题切换
                this.themeBtn.addEventListener('click', () => this.toggleTheme());

                // 键盘快捷键
                document.addEventListener('keydown', (e) => {
                    // ESC键关闭编辑器或模态框
                    if (e.key === 'Escape') {
                        if (this.editorContainer.classList.contains('active')) {
                            this.closeEditorHandler();
                        } else {
                            this.closeAllModals();
                        }
                    }

                    // Ctrl/Cmd + S 保存笔记
                    if ((e.ctrlKey || e.metaKey) && e.key === 's' && this.editorContainer.classList.contains('active')) {
                        e.preventDefault();
                        this.saveNoteHandler();
                    }
                });

                // 页面可见性变化时保存
                document.addEventListener('visibilitychange', () => {
                    if (document.hidden && this.editorContainer.classList.contains('active')) {
                        this.triggerAutoSave();
                    }
                });
            }

            // ===== 数据操作 =====
            async loadCategories() {
                this.categoriesList = await this.dbManager.getAllCategories();
                console.log('加载的分类列表:', this.categoriesList);
                return this.categoriesList;
            }

            async loadNotes() {
                this.notes = await this.dbManager.getAllNotes();
                return this.notes;
            }

            async loadSettings() {
                const autoSaveInterval = await this.dbManager.getSetting('autoSaveInterval', CONFIG.AUTO_SAVE_INTERVAL);
                const showAutoSaveStatus = await this.dbManager.getSetting('showAutoSaveStatus', true);
                
                this.settings = {
                    autoSaveInterval,
                    showAutoSaveStatus
                };
                
                return this.settings;
            }

            async updateSetting(key, value) {
                this.settings[key] = value;
                await this.dbManager.saveSetting(key, value);
            }

            // ===== 分类管理 =====
            async renderCategories() {
                const categories = await this.loadCategories();
                
                this.categories.innerHTML = `
                    <button class="category-btn active" data-category="all">
                        <i class="fas fa-list"></i> 全部
                    </button>
                `;

                categories.forEach(category => {
                    const btn = document.createElement('button');
                    btn.className = 'category-btn';
                    btn.dataset.category = category.id;
                    btn.innerHTML = `<i class="fas ${category.icon}"></i> ${category.name}`;
                    btn.style.borderLeftColor = category.color;
                    this.categories.appendChild(btn);
                });
            }

			async renderCategorySelect() {
				// === 新增：防御性代码 - 在清空前保存当前值 ===
				const currentSelectedValue = this.categorySelect.value;
				// 也可以考虑从正在编辑的笔记中获取（如果存在）
				const targetValue = this.editingNoteId ? (await this.dbManager.getNote(this.editingNoteId))?.category : currentSelectedValue;

				const categories = await this.loadCategories();
				this.categorySelect.innerHTML = ''; // 清空选项

				categories.forEach(category => {
					const option = document.createElement('option');
					option.value = category.id;
					option.textContent = category.name;
					this.categorySelect.appendChild(option);
				});

				// === 新增：恢复选中的值 ===
				const valueToSet = targetValue || currentSelectedValue || 'daily';
				// 确保要设置的值在下拉菜单选项中存在
				if (this.categorySelect.querySelector(`option[value="${valueToSet}"]`)) {
					this.categorySelect.value = valueToSet;
				} else if (categories.length > 0) {
					// 如果不存在（例如分类被删除），则回退到第一个可用分类
					this.categorySelect.value = categories[0].id;
				}
			}

            // 显示分类管理模态框
            async showCategoryManageModal() {
                console.log('显示分类管理模态框');
                await this.renderCategoryList();
                this.showModal(this.categoryManageModal);
            }

            // 渲染分类列表到模态框
            async renderCategoryList() {
                const categories = await this.loadCategories();
                console.log('渲染分类列表，分类数量:', categories.length);
                this.categoryList.innerHTML = '';
                
                if (categories.length === 0) {
                    this.categoryList.innerHTML = '<div class="empty-state">暂无分类</div>';
                    return;
                }
                
                categories.forEach(category => {
                    const isDefault = CONFIG.DEFAULT_CATEGORIES.some(cat => cat.id === category.id);
                    
                    const item = document.createElement('div');
                    item.className = 'category-item';
                    item.innerHTML = `
                        <input type="color" class="category-color-picker" value="${category.color}" data-id="${category.id}"
                               ${isDefault ? 'disabled' : ''}>
                        <input type="text" class="category-name-input" value="${category.name}" data-id="${category.id}"
                               ${isDefault ? 'disabled' : ''}>
                        <div class="category-actions">
                            ${isDefault ? 
                                '<button class="category-action-btn" disabled title="默认分类不能删除"><i class="fas fa-lock"></i></button>' :
                                `<button class="category-action-btn delete-category-btn" data-id="${category.id}" title="删除分类">
                                    <i class="fas fa-trash"></i>
                                </button>`
                            }
                        </div>
                    `;
                    this.categoryList.appendChild(item);
                });

                // 绑定分类列表中的事件
                this.bindCategoryListEvents();
            }

            // 绑定分类列表中的事件
            bindCategoryListEvents() {
                // 删除分类按钮点击事件 - 使用事件委托
                this.categoryList.addEventListener('click', (e) => {
                    const deleteBtn = e.target.closest('.delete-category-btn');
                    if (deleteBtn) {
                        const id = deleteBtn.dataset.id;
                        this.deleteCategory(id);
                        return;
                    }
                });

                // 颜色选择器变化事件
                this.categoryList.addEventListener('change', (e) => {
                    if (e.target.classList.contains('category-color-picker')) {
                        const id = e.target.dataset.id;
                        const color = e.target.value;
                        this.updateCategory(id, null, color);
                    }
                });

                // 名称输入框失去焦点事件
                this.categoryList.addEventListener('blur', (e) => {
                    if (e.target.classList.contains('category-name-input')) {
                        const id = e.target.dataset.id;
                        const name = e.target.value;
                        this.updateCategory(id, name);
                    }
                }, true);
            }

            async addNewCategory() {
                const name = this.newCategoryName.value.trim();
                const color = this.newCategoryColor.value;
                
                if (!name) {
                    this.showMessage('请输入分类名称', 'error');
                    return;
                }

                // 检查分类名称是否已存在
                const existingCategory = this.categoriesList.find(cat => cat.name.toLowerCase() === name.toLowerCase());
                if (existingCategory) {
                    this.showMessage('分类名称已存在', 'error');
                    return;
                }

                const newCategory = {
                    id: 'cat_' + Date.now(),
                    name: name,
                    color: color,
                    icon: 'fa-tag'
                };

                try {
                    await this.dbManager.saveCategory(newCategory);
                    this.newCategoryName.value = '';
                    
                    // 重新加载并渲染分类
                    await this.loadCategories();
                    await this.renderCategoryList();
                    await this.renderCategories();
                    await this.renderCategorySelect();
                    
                    this.showMessage('分类添加成功', 'success');
                } catch (error) {
                    if (error.message.includes('已存在')) {
                        this.showMessage('分类名称已存在', 'error');
                    } else {
                        this.showMessage('添加分类失败: ' + error.message, 'error');
                    }
                }
            }

            async updateCategory(id, name = null, color = null) {
                try {
                    const category = this.categoriesList.find(cat => cat.id === id);
                    
                    if (!category) {
                        this.showMessage('分类不存在', 'error');
                        return;
                    }

                    // 检查是否是默认分类
                    const isDefault = CONFIG.DEFAULT_CATEGORIES.some(cat => cat.id === id);
                    if (isDefault) {
                        this.showMessage('默认分类不能修改', 'error');
                        return;
                    }

                    // 检查名称是否重复
                    if (name && name !== category.name) {
                        const existing = this.categoriesList.find(cat => cat.name.toLowerCase() === name.toLowerCase() && cat.id !== id);
                        if (existing) {
                            this.showMessage('分类名称已存在', 'error');
                            return;
                        }
                    }

                    const updatedCategory = {
                        ...category,
                        name: name || category.name,
                        color: color || category.color
                    };

                    await this.dbManager.saveCategory(updatedCategory);
                    
                    // 重新加载并渲染分类
                    await this.loadCategories();
                    await this.renderCategories();
                    await this.renderCategorySelect();
                    
                    // 重新渲染分类列表（模态框内）
                    await this.renderCategoryList();
                    
                    this.showMessage('分类已更新', 'success');
                } catch (error) {
                    this.showMessage('更新分类失败: ' + error.message, 'error');
                }
            }

            async deleteCategory(id) {
                // 检查是否是默认分类
                const isDefault = CONFIG.DEFAULT_CATEGORIES.some(cat => cat.id === id);
                if (isDefault) {
                    this.showMessage('默认分类不能删除', 'error');
                    return;
                }

                if (!confirm('删除分类会将相关笔记归类到"其他"，确定删除吗？')) {
                    return;
                }

                try {
                    // 先更新相关笔记的分类为'other'
                    const notes = await this.dbManager.getAllNotes();
                    for (const note of notes) {
                        if (note.category === id) {
                            note.category = 'other';
                            await this.dbManager.saveNote(note);
                        }
                    }

                    // 删除分类
                    await this.dbManager.deleteCategory(id);
                    
                    // 重新加载并渲染分类
                    await this.loadCategories();
                    await this.renderCategories();
                    await this.renderCategorySelect();
                    await this.renderCategoryList();
                    await this.renderNotes();
                    
                    this.showMessage('分类已删除', 'success');
                } catch (error) {
                    this.showMessage('删除分类失败: ' + error.message, 'error');
                }
            }

            // ===== 笔记管理 =====
            async renderNotes() {
                const notes = await this.dbManager.searchNotes(this.currentSearch, this.currentFilter);
                this.notesList.innerHTML = '';

                if (notes.length === 0) {
                    this.showEmptyState();
                    return;
                }

                const categories = await this.loadCategories();
                const categoryMap = {};
                categories.forEach(cat => categoryMap[cat.id] = cat);

                notes.forEach(note => {
                    const noteElement = this.createNoteElement(note, categoryMap);
                    this.notesList.appendChild(noteElement);
                });
            }

            createNoteElement(note, categoryMap) {
                const noteElement = document.createElement('div');
                noteElement.className = 'note-item fade-in';
                noteElement.dataset.id = note.id;

                const category = categoryMap[note.category];
                const categoryName = category ? category.name : note.category;
                const categoryColor = category ? category.color : '#6c757d';
                const categoryIcon = category ? category.icon : 'fa-tag';

                const previewContent = note.content
                    .replace(/\n/g, ' ')
                    .substring(0, 120) + (note.content.length > 120 ? '...' : '');

                noteElement.innerHTML = `
                    <div class="note-header">
                        <div class="note-title">${this.escapeHtml(note.title)}</div>
                        <div class="note-category" style="background: ${categoryColor}20; color: ${categoryColor}">
                            <i class="fas ${categoryIcon}"></i> ${this.escapeHtml(categoryName)}
                        </div>
                    </div>
                    <div class="note-content-preview">${this.escapeHtml(previewContent)}</div>
                    <div class="note-footer">
                        <div class="note-time">${this.formatDate(new Date(note.updatedAt))}</div>
                    </div>
                `;

                noteElement.addEventListener('click', () => this.openEditor(note.id));
                return noteElement;
            }

			async openEditor(noteId = null) {
				// 1. 隐藏其他面板...
				this.exportSection.style.display = 'none';
				this.settingsSection.style.display = 'none';

				this.editingNoteId = noteId;
				this.lastSavedContent = '';

				// 2. === 关键：先等待分类下拉菜单渲染完成 ===
				await this.renderCategorySelect();

				// 3. 现在再根据 noteId 获取数据并填充表单
				if (noteId) {
					const note = await this.dbManager.getNote(noteId);
					if (note) {
						this.noteTitleInput.value = note.title;
						this.noteContentInput.value = note.content;
						// 此时下拉菜单已就绪，直接设置值
						this.categorySelect.value = note.category;
						this.noteTimeDisplay.textContent = `最后编辑: ${this.formatDate(new Date(note.updatedAt))}`;
						this.deleteNote.style.color = '#FF3B30';
						// === 新增：调试日志，确认设置成功 ===
						console.log(`[DEBUG] 设置分类为: ${note.category}, 当前select.value是: ${this.categorySelect.value}`);
					}
				} else {
					// 新建笔记...
					this.noteTitleInput.value = '';
					this.noteContentInput.value = '';
					this.categorySelect.value = 'daily';
					this.noteTimeDisplay.textContent = '新笔记';
					this.deleteNote.style.color = '';
				}

                this.timestampToolbar.style.display = 'none';
                this.editorContainer.classList.add('active');
                await this.renderCategorySelect();

                setTimeout(() => {
                    if (this.noteTitleInput.value === '') {
                        this.noteTitleInput.focus();
                    } else {
                        this.noteContentInput.focus();
                    }
                }, 100);
            }

            closeEditorHandler() {
                this.stopAutoSave();
                this.editorContainer.classList.remove('active');
                this.editingNoteId = null;
                this.timestampToolbar.style.display = 'none';
                this.hideAutoSaveStatus();
            }

            async saveNoteHandler() {
                const title = this.noteTitleInput.value.trim() || "未命名笔记";
                const content = this.noteContentInput.value;
                const category = this.categorySelect.value;

                const now = new Date().toISOString();
                const noteData = {
                    id: this.editingNoteId || Date.now(),
                    title: title,
                    content: content,
                    category: category,
                    updatedAt: now,
                    createdAt: this.editingNoteId ? undefined : now
                };

                try {
                    await this.dbManager.saveNote(noteData);
                    await this.renderNotes();
                    this.showMessage('笔记已保存', 'success');
                    
                    if (!this.editingNoteId) {
                        this.editingNoteId = noteData.id;
                    }
                    
                    this.lastSavedContent = content;
                } catch (error) {
                    this.showMessage('保存失败: ' + error.message, 'error');
                }
            }

            async deleteNoteHandler() {
                if (!this.editingNoteId) return;

                if (confirm('确定要删除这篇笔记吗？此操作无法撤销。')) {
                    try {
                        await this.dbManager.deleteNote(this.editingNoteId);
                        await this.renderNotes();
                        this.closeEditorHandler();
                        this.showMessage('笔记已删除', 'success');
                    } catch (error) {
                        this.showMessage('删除失败: ' + error.message, 'error');
                    }
                }
            }

            // ===== 自动保存 =====
            triggerAutoSave() {
                if (!this.noteContentInput.value.trim()) return;

                this.stopAutoSave();

                if (this.settings.showAutoSaveStatus) {
                    this.showAutoSaveStatus('saving', '正在保存...');
                }

                this.autoSaveTimer = setTimeout(() => {
                    this.saveNoteHandler().then(() => {
                        if (this.settings.showAutoSaveStatus) {
                            this.showAutoSaveStatus('saved', '已自动保存');
                            setTimeout(() => this.hideAutoSaveStatus(), 2000);
                        }
                    }).catch(error => {
                        if (this.settings.showAutoSaveStatus) {
                            this.showAutoSaveStatus('error', '保存失败');
                            setTimeout(() => this.hideAutoSaveStatus(), 2000);
                        }
                    });
                }, this.settings.autoSaveInterval);
            }

            stopAutoSave() {
                if (this.autoSaveTimer) {
                    clearTimeout(this.autoSaveTimer);
                    this.autoSaveTimer = null;
                }
            }

            showAutoSaveStatus(type, message) {
                this.autoSaveStatus.textContent = message;
                this.autoSaveStatus.className = `auto-save-status show ${type}`;
            }

            hideAutoSaveStatus() {
                this.autoSaveStatus.classList.remove('show');
            }

            // ===== 时间戳功能 =====
            toggleTimestampToolbar() {
                const isVisible = this.timestampToolbar.style.display === 'flex';
                this.timestampToolbar.style.display = isVisible ? 'none' : 'flex';
            }

            handleTimestampInsert(format) {
                if (format === 'custom') {
                    this.showModal(this.customTimestampModal);
                    this.updateFormatPreview();
                } else {
                    this.insertTimestamp(format);
                }
            }

            insertTimestamp(format) {
                const textarea = this.noteContentInput;
                const cursorPos = textarea.selectionStart;
                const currentValue = textarea.value;
                
                const timestamp = this.formatTimestamp(new Date(), this.getTimestampFormat(format));
                
                const newValue = currentValue.substring(0, cursorPos) + timestamp + currentValue.substring(cursorPos);
                textarea.value = newValue;
                
                const newCursorPos = cursorPos + timestamp.length;
                textarea.setSelectionRange(newCursorPos, newCursorPos);
                textarea.focus();
                
                this.timestampToolbar.style.display = 'none';
                this.showMessage('时间戳已插入', 'info');
            }

            insertCustomTimestampHandler() {
                const format = this.customFormatInput.value;
                if (!format.trim()) {
                    this.showMessage('请输入时间格式', 'error');
                    return;
                }

                this.insertTimestamp('custom');
                this.hideModal(this.customTimestampModal);
            }

            getTimestampFormat(format) {
                switch(format) {
                    case 'datetime': return 'YYYY年MM月DD日 HH:mm:ss';
                    case 'date': return 'YYYY年MM月DD日';
                    case 'time': return 'HH:mm:ss';
                    case 'week': return 'YYYY年MM月DD日 ddd';
                    case 'custom': return this.customFormatInput.value;
                    default: return 'YYYY年MM月DD日 HH:mm:ss';
                }
            }

            updateFormatPreview() {
                const format = this.customFormatInput.value;
                if (!format.trim()) return;

                try {
                    const preview = this.formatTimestamp(new Date(), format);
                    this.formatPreview.textContent = preview;
                } catch (error) {
                    this.formatPreview.textContent = '格式错误';
                }
            }

            formatTimestamp(date, format) {
                const d = new Date(date);
                const pad = (n) => n.toString().padStart(2, '0');

                const weekdays = ['星期日', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];

                const replacements = {
                    'YYYY': d.getFullYear(),
                    'MM': pad(d.getMonth() + 1),
                    'DD': pad(d.getDate()),
                    'HH': pad(d.getHours()),
                    'mm': pad(d.getMinutes()),
                    'ss': pad(d.getSeconds()),
                    'ddd': weekdays[d.getDay()]
                };

                let result = format;
                for (const [key, value] of Object.entries(replacements)) {
                    result = result.replace(new RegExp(key, 'g'), value);
                }

                return result;
            }

            // ===== 搜索和筛选 =====
            async handleSearch(searchTerm) {
                this.currentSearch = searchTerm;
                await this.renderNotes();
                this.clearSearch.style.display = searchTerm ? 'block' : 'none';
            }

            clearSearchHandler() {
                this.searchInput.value = '';
                this.handleSearch('');
            }

            toggleSearch() {
                this.exportSection.style.display = 'none';
                this.settingsSection.style.display = 'none';
                
                if (this.searchContainer.style.display === 'none') {
                    this.searchContainer.style.display = 'block';
                    this.searchInput.focus();
                } else {
                    this.searchContainer.style.display = 'none';
                    this.clearSearchHandler();
                }
            }

            async handleCategoryFilter(category) {
                document.querySelectorAll('.category-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                event.target.classList.add('active');

                this.currentFilter = category;
                await this.renderNotes();
            }

            // ===== 导入导出 =====
            toggleExportSection() {
                this.searchContainer.style.display = 'none';
                this.clearSearchHandler();
                
                if (this.exportSection.style.display === 'none') {
                    this.exportSection.style.display = 'block';
                    this.settingsSection.style.display = 'block';
                } else {
                    this.exportSection.style.display = 'none';
                    this.settingsSection.style.display = 'none';
                }
            }

            async exportNotes(format) {
                try {
                    const notes = await this.dbManager.getAllNotes();
                    const categories = await this.dbManager.getAllCategories();
                    
                    let content, filename, mimeType;

                    if (format === 'json') {
                        const exportData = {
                            app: "素记日记",
                            version: "2.0",
                            exportDate: new Date().toISOString(),
                            noteCount: notes.length,
                            categories: categories,
                            notes: notes
                        };

                        content = JSON.stringify(exportData, null, 2);
                        filename = `素记日记_${this.formatDateForFile(new Date())}.json`;
                        mimeType = 'application/json';
                    } else {
                        let mdContent = `# 素记日记 - 笔记导出\n\n`;
                        mdContent += `- **导出时间**: ${this.formatTimestamp(new Date(), 'YYYY年MM月DD日 HH:mm:ss')}\n`;
                        mdContent += `- **笔记总数**: ${notes.length}\n`;
                        mdContent += `- **分类数量**: ${categories.length}\n\n`;
                        mdContent += `---\n\n`;

                        const categoryMap = {};
                        categories.forEach(cat => categoryMap[cat.id] = cat);

                        notes.forEach((note, index) => {
                            const category = categoryMap[note.category] || { name: note.category };
                            const createdTime = this.formatTimestamp(new Date(note.createdAt || note.updatedAt), 'YYYY年MM月DD日 HH:mm:ss');
                            const updatedTime = this.formatTimestamp(new Date(note.updatedAt), 'YYYY年MM月DD日 HH:mm:ss');

                            mdContent += `## 笔记 ${index + 1}: ${note.title}\n\n`;
                            mdContent += `- **分类**: ${category.name}\n`;
                            mdContent += `- **创建时间**: ${createdTime}\n`;
                            mdContent += `- **最后修改**: ${updatedTime}\n\n`;
                            mdContent += `---\n\n`;
                            mdContent += `${note.content}\n\n`;
                            mdContent += `---\n\n`;
                        });

                        content = mdContent;
                        filename = `素记日记_${this.formatDateForFile(new Date())}.md`;
                        mimeType = 'text/markdown';
                    }

                    const blob = new Blob([content], { type: mimeType });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = filename;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    this.showMessage(`笔记已导出为${format === 'json' ? 'JSON' : 'Markdown'}文件`, 'success');
                } catch (error) {
                    this.showMessage(`导出失败: ${error.message}`, 'error');
                }
            }

            showImportModal() {
                this.showModal(this.importModal);
            }

            importNotes(format) {
                this.hideModal(this.importModal);

                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.style.display = 'none';
                fileInput.accept = format === 'json' ? '.json' : '.md,.txt';
                
                fileInput.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (!file) return;

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        try {
                            const content = event.target.result;
                            
                            if (format === 'json') {
                                const importData = JSON.parse(content);
                                
                                if (!importData.notes || !Array.isArray(importData.notes)) {
                                    throw new Error('无效的JSON文件格式');
                                }

                                let importedCount = 0;
                                for (const note of importData.notes) {
                                    try {
                                        const noteData = {
                                            id: note.id || Date.now() + Math.random(),
                                            title: note.title || "未命名笔记",
                                            content: note.content || "",
                                            category: note.category || "other",
                                            createdAt: note.createdAt || new Date().toISOString(),
                                            updatedAt: note.updatedAt || new Date().toISOString()
                                        };
                                        
                                        await this.dbManager.saveNote(noteData);
                                        importedCount++;
                                    } catch (error) {
                                        console.error('导入笔记失败:', error);
                                    }
                                }

                                this.showMessage(`成功导入 ${importedCount} 条笔记`, 'success');
                            } else {
                                // 简单解析Markdown
                                const lines = content.split('\n');
                                let currentNote = null;
                                let importedCount = 0;
                                
                                for (let i = 0; i < lines.length; i++) {
                                    const line = lines[i];
                                    
                                    if (line.startsWith('## 笔记')) {
                                        if (currentNote) {
                                            await this.saveCurrentNote(currentNote);
                                            importedCount++;
                                        }
                                        
                                        const titleMatch = line.match(/## 笔记 \d+: (.+)/);
                                        currentNote = {
                                            title: titleMatch ? titleMatch[1] : "未命名笔记",
                                            content: "",
                                            category: "other"
                                        };
                                    } else if (currentNote && line.trim() && !line.startsWith('- **')) {
                                        currentNote.content += line + '\n';
                                    }
                                }
                                
                                if (currentNote) {
                                    await this.saveCurrentNote(currentNote);
                                    importedCount++;
                                }
                                
                                this.showMessage(`成功导入 ${importedCount} 条笔记`, 'success');
                            }
                            
                            await this.renderNotes();
                        } catch (error) {
                            this.showMessage(`导入失败: ${error.message}`, 'error');
                        }
                    };

                    reader.readAsText(file);
                });

                document.body.appendChild(fileInput);
                fileInput.click();
                setTimeout(() => document.body.removeChild(fileInput), 1000);
            }

            async saveCurrentNote(note) {
                const noteData = {
                    id: Date.now() + Math.random(),
                    title: note.title,
                    content: note.content.trim(),
                    category: note.category,
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString()
                };
                
                await this.dbManager.saveNote(noteData);
            }

            async createBackup() {
                try {
                    const notes = await this.dbManager.getAllNotes();
                    const categories = await this.dbManager.getAllCategories();
                    const settings = await this.loadSettings();
                    
                    const backupData = {
                        timestamp: new Date().toISOString(),
                        notes: notes,
                        categories: categories,
                        settings: settings
                    };
                    
                    await this.dbManager.saveSetting('lastBackup', backupData.timestamp);
                    this.showMessage(`备份已创建 (${this.formatDate(new Date())})`, 'success');
                } catch (error) {
                    this.showMessage(`创建备份失败: ${error.message}`, 'error');
                }
            }

            showClearDataModal() {
                this.showModal(this.clearDataModal);
            }

            async confirmClearDataHandler() {
                try {
                    await this.dbManager.clearAllData();
                    this.hideModal(this.clearDataModal);
                    this.exportSection.style.display = 'none';
                    this.settingsSection.style.display = 'none';
                    await this.loadCategories();
                    await this.renderCategories();
                    await this.renderNotes();
                    this.showMessage('所有笔记已清除', 'success');
                } catch (error) {
                    this.showMessage(`清除数据失败: ${error.message}`, 'error');
                }
            }

            // ===== UI辅助功能 =====
            showEmptyState() {
                const emptyState = document.createElement('div');
                emptyState.className = 'empty-state';

                let message = '暂无笔记';
                if (this.currentSearch !== '') {
                    message = '未找到匹配的笔记';
                } else if (this.currentFilter !== 'all') {
                    const category = this.categoriesList?.find(cat => cat.id === this.currentFilter)?.name || this.currentFilter;
                    message = `暂无"${category}"分类的笔记`;
                }

                emptyState.innerHTML = `
                    <i class="fas fa-sticky-note"></i>
                    <h3>${message}</h3>
                    <p>点击右下角的 + 按钮创建新笔记</p>
                `;

                this.notesList.appendChild(emptyState);
            }

            showModal(modal) {
                modal.classList.add('active');
                document.body.style.overflow = 'hidden';
            }

            hideModal(modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }

            closeAllModals() {
                document.querySelectorAll('.modal-overlay').forEach(modal => {
                    modal.classList.remove('active');
                });
                document.body.style.overflow = '';
            }

            // ===== 设置 =====
            loadSettingsToUI() {
                this.autoSaveIntervalInput.value = this.settings.autoSaveInterval / 1000;
                this.autoSaveShowStatus.checked = this.settings.showAutoSaveStatus;
            }

            toggleTheme() {
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                
                if (isDark) {
                    document.documentElement.removeAttribute('data-theme');
                    localStorage.setItem('simpleNotesTheme', 'light');
                    this.themeBtn.innerHTML = '<i class="fas fa-moon"></i>';
                } else {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    localStorage.setItem('simpleNotesTheme', 'dark');
                    this.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }

            initTheme() {
                const savedTheme = localStorage.getItem('simpleNotesTheme');
                const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
                
                if (savedTheme === 'dark' || (!savedTheme && prefersDark)) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                    this.themeBtn.innerHTML = '<i class="fas fa-sun"></i>';
                }
            }

            // ===== 工具函数 =====
            showMessage(message, type = 'info') {
                // 移除现有的消息
                const existingMessages = document.querySelectorAll('.custom-message');
                existingMessages.forEach(msg => msg.remove());

                const messageEl = document.createElement('div');
                messageEl.textContent = message;
                messageEl.className = 'custom-message';

                const colors = {
                    success: { bg: '#34C759', text: '#FFFFFF' },
                    error: { bg: '#FF3B30', text: '#FFFFFF' },
                    warning: { bg: '#FF9500', text: '#FFFFFF' },
                    info: { bg: '#5D5CDE', text: '#FFFFFF' }
                };

                const color = colors[type] || colors.info;
                
                messageEl.style.cssText = `
                    position: fixed;
                    top: 80px;
                    left: 50%;
                    transform: translateX(-50%);
                    background-color: ${color.bg};
                    color: ${color.text};
                    padding: 12px 24px;
                    border-radius: var(--radius);
                    z-index: 1000;
                    box-shadow: var(--shadow);
                    animation: fadeIn 0.3s ease;
                    font-weight: 500;
                    max-width: 80%;
                    text-align: center;
                `;

                document.body.appendChild(messageEl);
                setTimeout(() => {
                    messageEl.style.opacity = '0';
                    messageEl.style.transition = 'opacity 0.3s ease';
                    setTimeout(() => messageEl.remove(), 300);
                }, 3000);
            }

            formatDate(date) {
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMs / 3600000);
                const diffDays = Math.floor(diffMs / 86400000);

                if (diffMins < 1) return '刚刚';
                if (diffMins < 60) return `${diffMins}分钟前`;
                if (diffHours < 24) return `${diffHours}小时前`;
                if (diffDays < 7) return `${diffDays}天前`;
                
                return date.toLocaleDateString('zh-CN', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
            }

            formatDateForFile(date) {
                const d = new Date(date);
                const pad = (n) => n.toString().padStart(2, '0');
                return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
            }

            escapeHtml(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }

        // ===== 初始化应用 =====
        document.addEventListener('DOMContentLoaded', () => {
            // 添加暗色模式样式
            const darkModeStyles = `
                <style>
                    [data-theme="dark"] {
                        --bg-color: #121212;
                        --card-color: #1E1E1E;
                        --text-primary: #E0E0E0;
                        --text-secondary: #AAAAAA;
                        --border-color: #333333;
                        --shadow: 0 2px 12px rgba(0, 0, 0, 0.3);
                        --primary-color: #8A8AFF;
                        --secondary-color: #A5A5FF;
                    }
                    
                    [data-theme="dark"] .search-box {
                        background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%23AAAAAA' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cline x1='21' y1='21' x2='16.65' y2='16.65'%3E%3C/line%3E%3C/svg%3E");
                    }
                    
                    [data-theme="dark"] .icon-btn:hover,
                    [data-theme="dark"] .icon-btn:active {
                        background-color: rgba(255, 255, 255, 0.1);
                    }
                    
                    [data-theme="dark"] .empty-state i {
                        color: #333333;
                    }
                    
                    [data-theme="dark"] .export-btn.secondary {
                        background-color: #2C2C2C;
                    }
                    
                    [data-theme="dark"] .timestamp-btn {
                        background-color: rgba(138, 138, 255, 0.1);
                        border-color: rgba(138, 138, 255, 0.2);
                    }
                </style>
            `;
            document.head.insertAdjacentHTML('beforeend', darkModeStyles);

            // 初始化应用
            window.app = new SimpleNotesApp();
            
            // 初始化主题
            window.app.initTheme();
        });
    </script>
</body>
</html>
